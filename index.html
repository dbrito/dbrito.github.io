<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <title>POC - YOLO</title>
    <style>
        .main {
            display:table;
            width: 100%;
            height: 100vh;
            /*background: #F00 url(/img/bg.jpg);*/
            /*background-size: cover;*/
        }

        .centered-item {
            display: table-cell;
            vertical-align: middle;
        }

        .login {
            width: 400px;
        }

        #welcome {
            display: none;
        }
    </style>
</head>
<body>
    <div class="errorviewr"></div>
    <div class="main">
        <div class="centered-item">
            <div class="row login">
                <form id="form" method="post">
                    <div class="row">
                        <div class="input-field">
                            <input id="id" name="id" type="text" autocomplete="username">
                            <label class="active" for="id">Usu치rio</label>
                        </div>
                        <div class="input-field">
                            <input id="password" name="password" type="password" autocomplete="current-password">
                            <label class="active" for="password">Senha</label>
                        </div>
                        <input class="waves-effect waves-light btn-large" type="submit">
                    </div>
                </form>
                <div id="welcome">
                    <h2>Ol치, seja bem vindo</h2>
                </div>
            </div>
        </div>
    </div>
    <script src="https://smartlock.google.com/client"></script>
    <script type="text/javascript">
        window.onload = function() {
            createCredential()
        }
        //FLUXO DE LOGIN (FAKE)
        function createCredential() {
            var teste = document.querySelector('#form');
            teste.onsubmit = function (e) {
                try {
                    e.preventDefault();

                    var cred = new PasswordCredential({
                        id: teste.querySelector('input[name="id"]').value,
                        password: teste.querySelector('input[name="password"]').value,
                        name:     'POC',
                        iconURL: ('https://A'+Date.now()+'.com')
                    });

                    var fecthOptions = {
                         method: 'POST',
                         mode: 'cors'
                    };

                    fetch('https://www.mocky.io/v2/5185415ba171ea3a00704eed', fecthOptions).then((res)=>{
                        navigator.credentials.store(cred).then(() => {
                            document.querySelector('form').style.display = 'none';
                            document.querySelector('#welcome').style.display = 'block';
                            var hash = cred.iconURL;
                            hash = hash.split('a')[1].split('.')[0];
                            document.querySelector('#welcome h2').innerHTML = 'Ol치 ' + cred.id + '<br> #' + hash.substr(5);

                            console.log('Credencial armazenada', cred);
                        });
                    })
                } catch (err) {
                    console.log(err);
                }

            }
        }

        //USO DO YOLO
        window.onGoogleYoloLoad = (googleyolo) => {
            const retrievePromise = googleyolo.retrieve({
                supportedAuthMethods: [
                    "https://accounts.google.com",
                    "googleyolo://id-and-password"
                ],
                supportedIdTokenProviders: [{
                    uri: "https://accounts.google.com",
                    clientId: "778056338612-hvsq70lnuin04df5nhmv0btus5ep9bvi.apps.googleusercontent.com"
                }]
            });

            retrievePromise.then((credential)=>{
                if (credential.password) {
                    document.querySelector('form').style.display = 'none';
                    document.querySelector('#welcome').style.display = 'block';
                    var hash = credential.profilePicture;
                    hash = hash.split('a')[1].split('.')[0];
                    document.querySelector('#welcome h2').innerHTML = 'Ol치 ' + credential.id + '<br> #' + hash.substr(5);
                }
                console.debug('HERE', credential);
            }).catch((err)=> {
                console.log(err);
            });
        };
    </script>
</body>
</html>
