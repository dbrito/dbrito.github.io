<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <title>POC - YOLO</title>
    <style>
        .main {
            display:table;
            width: 100%;
            height: 100vh;
            /*background: #F00 url(/img/bg.jpg);*/
            /*background-size: cover;*/
        }

        .centered-item {
            display: table-cell;
            vertical-align: middle;
        }

        .login {
            width: 400px;
        }

        #welcome {
            display: none;
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="centered-item">
            <div class="row login">
                <form id="form" method="post">
                    <div class="row">
                        <div class="input-field">
                            <input id="id" name="id" type="text" autocomplete="username">
                            <label class="active" for="id">Usu치rio</label>
                        </div>
                        <div class="input-field">
                            <input id="password" name="password" type="password" autocomplete="current-password">
                            <label class="active" for="password">Senha</label>
                        </div>
                        <input class="waves-effect waves-light btn-large" type="submit">
                    </div>
                </form>
                <div id="welcome">
                    <h2>Ol치 MEUK, seja bem vindo</h2>
                </div>
            </div>
        </div>
    </div>


    <script src="https://smartlock.google.com/client"></script>
    <script type="text/javascript">

        window.onload = function() {
            createCredential()
        }

        function createCredential() {
            var teste = document.querySelector('#form');
            teste.onsubmit = function (e) {
                e.preventDefault();
                var cred = new PasswordCredential({
                    id: teste.querySelector('input[name="id"]').value,
                    password: teste.querySelector('input[name="password"]').value,
                    name:     'danese',
                    iconURL: 'https://lh3.googleusercontent.com/-mR4jzYb5-mc/AAAAAAAAAAI/AAAAAAAABNE/0VRSVuzuHCE/photo.jpg?sz=96'
                });

                var fecthOptions = {
                     method: 'POST',
                     mode: 'cors',
                     credentials: cred
                };

                fetch('https://www.mocky.io/v2/5185415ba171ea3a00704eed', fecthOptions).then((res)=>{
                    navigator.credentials.store(cred).then(() => {
                        document.querySelector('form').style.display = 'none';
                        document.querySelector('#welcome').style.display = 'block';
                        document.querySelector('#welcome h2').innerHTML = 'Ol치 ' + credential.id;
                        console.log('Credencial armazenada', cred);
                    });
                })
            }
        }

        window.onGoogleYoloLoad = (googleyolo) => {
            const retrievePromise = googleyolo.retrieve({
                supportedAuthMethods: [
                    "https://accounts.google.com",
                    "googleyolo://id-and-password"
                ],
                supportedIdTokenProviders: [{
                    uri: "https://accounts.google.com",
                    clientId: "778056338612-hvsq70lnuin04df5nhmv0btus5ep9bvi.apps.googleusercontent.com"
                }]
            });

            retrievePromise.then((credential)=>{
                if (credential.password) {
                    document.querySelector('form').style.display = 'none';
                    document.querySelector('#welcome').style.display = 'block';
                    document.querySelector('#welcome h2').innerHTML = 'Ol치 ' + credential.id;
                }
                console.debug('MEUK', credential);
            }).catch((err)=> {
                console.error(err);
                /*const hintPromise = googleyolo.hint({
                    supportedAuthMethods: [
                        "https://accounts.google.com"
                    ],
                    supportedIdTokenProviders: [{
                        uri: "https://accounts.google.com",
                        clientId: "778056338612-hvsq70lnuin04df5nhmv0btus5ep9bvi.apps.googleusercontent.com"
                    }]
                });
                hintPromise.then((credential) => {
                  console.log(credential);
                  if (credential.idToken) {

                    // Send the token to your auth backend.
                    //useGoogleIdTokenForAuth(credential.idToken);
                  }
                }, (error) => {
                  switch (error.type) {
                    case "userCanceled":
                      // The user closed the hint selector. Depending on the desired UX,
                      // request manual sign up or do nothing.
                      break;
                    case "noCredentialsAvailable":
                      // No hint available for the session. Depending on the desired UX,
                      // request manual sign up or do nothing.
                      break;
                    case "requestFailed":
                      // The request failed, most likely because of a timeout.
                      // You can retry another time if necessary.
                      break;
                    case "operationCanceled":
                      // The operation was programmatically canceled, do nothing.
                      break;
                    case "illegalConcurrentRequest":
                      // Another operation is pending, this one was aborted.
                      break;
                    case "initializationError":
                      // Failed to initialize. Refer to error.message for debugging.
                      break;
                    case "configurationError":
                      // Configuration error. Refer to error.message for debugging.
                      break;
                    default:
                      // Unknown error, do nothing.
                  }
                });*/
            });
        };
    </script>
</body>
</html>
